(function(e){var t={init:function(n){return this.each(function(){var r=e(this),i=r.data("eraser");if(!i){var s=function(){var s=r.width(),o=r.height(),u=r.offset(),a=e("<canvas/>"),f=a.get(0),l=n&&n.size?n.size:40,c=n&&n.completeRatio?n.completeRatio:.7,h=n&&n.completeFunction?n.completeFunction:null,p=n&&n.progressFunction?n.progressFunction:null,d=r.css("z-index")=="auto"?1:r.css("z-index"),v=[],m=Math.floor(s/l),g=m*Math.floor(o/l),y=g,b=f.getContext("2d"),w=r[0];r.after(a),f.id=w.id,f.className=w.className,f.width=s,f.height=o,b.drawImage(w,0,0,s,o),r.remove(),b.globalCompositeOperation="destination-out",b.strokeStyle="rgba(255,0,0,255)",b.lineWidth=l,b.lineCap="round",a.bind("mousedown.eraser",t.mouseDown),a.bind("touchstart.eraser",t.touchStart),a.bind("touchmove.eraser",t.touchMove),a.bind("touchend.eraser",t.touchEnd);while(y--)v.push(1);i={posX:u.left,posY:u.top,touchDown:!1,touchID:-999,touchX:0,touchY:0,ptouchX:0,ptouchY:0,canvas:a,ctx:b,w:s,h:o,source:w,size:l,parts:v,colParts:m,numParts:g,ratio:0,complete:!1,completeRatio:c,completeFunction:h,progressFunction:p,zIndex:d},a.data("eraser",i),e(window).resize(function(){var e=a.offset();i.posX=e.left,i.posY=e.top})};this.complete&&this.naturalWidth>0?s():r.load(s)}})},touchStart:function(n){var r=e(this),i=r.data("eraser");if(!i.touchDown){var s=n.originalEvent.changedTouches[0],o=s.pageX-i.posX,u=s.pageY-i.posY;t.evaluatePoint(i,o,u),i.touchDown=!0,i.touchID=s.identifier,i.touchX=o,i.touchY=u,n.preventDefault()}},touchMove:function(n){var r=e(this),i=r.data("eraser");if(i.touchDown){var s=n.originalEvent.changedTouches,o=s.length;while(o--)if(s[o].identifier==i.touchID){var u=s[o].pageX-i.posX,a=s[o].pageY-i.posY;t.evaluatePoint(i,u,a),i.ctx.beginPath(),i.ctx.moveTo(i.touchX,i.touchY),i.touchX=u,i.touchY=a,i.ctx.lineTo(i.touchX,i.touchY),i.ctx.stroke(),r.css({"z-index":r.css("z-index")==i.zIndex?parseInt(i.zIndex)+1:i.zIndex}),n.preventDefault();break}}},touchEnd:function(t){var n=e(this),r=n.data("eraser");if(r.touchDown){var i=t.originalEvent.changedTouches,s=i.length;while(s--)if(i[s].identifier==r.touchID){r.touchDown=!1,t.preventDefault();break}}},evaluatePoint:function(e,t,n){var r=Math.floor(t/e.size)+Math.floor(n/e.size)*e.colParts;r>=0&&r<e.numParts&&(e.ratio+=e.parts[r],e.parts[r]=0,e.complete||(r=e.ratio/e.numParts,r>=e.completeRatio?(e.complete=!0,e.completeFunction!=null&&e.completeFunction()):e.progressFunction!=null&&e.progressFunction(r)))},mouseDown:function(n){var r=e(this),i=r.data("eraser"),s=n.pageX-i.posX,o=n.pageY-i.posY;t.evaluatePoint(i,s,o),i.touchDown=!0,i.touchX=s,i.touchY=o,i.ctx.beginPath(),i.ctx.moveTo(i.touchX-1,i.touchY),i.ctx.lineTo(i.touchX,i.touchY),i.ctx.stroke(),r.bind("mousemove.eraser",t.mouseMove),e(document).bind("mouseup.eraser",i,t.mouseUp),n.preventDefault()},mouseMove:function(n){var r=e(this),i=r.data("eraser"),s=n.pageX-i.posX,o=n.pageY-i.posY;t.evaluatePoint(i,s,o),i.ctx.beginPath(),i.ctx.moveTo(i.touchX,i.touchY),i.touchX=s,i.touchY=o,i.ctx.lineTo(i.touchX,i.touchY),i.ctx.stroke(),r.css({"z-index":r.css("z-index")==i.zIndex?parseInt(i.zIndex)+1:i.zIndex}),n.preventDefault()},mouseUp:function(t){var n=t.data,r=n.canvas;n.touchDown=!1,r.unbind("mousemove.eraser"),e(document).unbind("mouseup.eraser"),t.preventDefault()},clear:function(){var t=e(this),n=t.data("eraser");if(n){n.ctx.clearRect(0,0,n.w,n.h);var r=n.numParts;while(r--)n.parts[r]=0;n.ratio=n.numParts,n.complete=!0,n.completeFunction!=null&&n.completeFunction()}},size:function(t){var n=e(this),r=n.data("eraser");r&&t&&(r.size=t,r.ctx.lineWidth=t)},reset:function(){var t=e(this),n=t.data("eraser");if(n){n.ctx.globalCompositeOperation="source-over",n.ctx.drawImage(n.source,0,0),n.ctx.globalCompositeOperation="destination-out";var r=n.numParts;while(r--)n.parts[r]=1;n.ratio=0,n.complete=!1,n.touchDown=!1}},progress:function(){var t=e(this),n=t.data("eraser");return n?n.ratio/n.numParts:0}};e.fn.eraser=function(n){if(t[n])return t[n].apply(this,Array.prototype.slice.call(arguments,1));if(typeof n=="object"||!n)return t.init.apply(this,arguments);e.error("Method "+n+" does not yet exist on jQuery.eraser")}})(jQuery);